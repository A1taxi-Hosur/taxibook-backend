{% extends "admin/base.html" %}

{% block title %}Promo Codes - A1 Call Taxi Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Promo Codes Management</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPromoModal">
                    <i class="bi bi-plus-circle"></i> Create New Promo Code
                </button>
            </div>

            <!-- Promo Codes Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Active Promo Codes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="promoCodesTable">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Discount</th>
                                    <th>Min Fare</th>
                                    <th>Usage</th>
                                    <th>Expiry</th>
                                    <th>Restrictions</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Promo Code Modal -->
<div class="modal fade" id="createPromoModal" tabindex="-1" aria-labelledby="createPromoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPromoModalLabel">Create New Promo Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createPromoForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="promoCode" class="form-label">Promo Code *</label>
                                <input type="text" class="form-control" id="promoCode" name="code" required 
                                       placeholder="WELCOME50" style="text-transform: uppercase;">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maxUses" class="form-label">Max Uses *</label>
                                <input type="number" class="form-control" id="maxUses" name="max_uses" required 
                                       min="1" value="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="discountType" class="form-label">Discount Type *</label>
                                <select class="form-select" id="discountType" name="discount_type" required>
                                    <option value="flat">Flat Amount (₹)</option>
                                    <option value="percent">Percentage (%)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="discountValue" class="form-label">Discount Value *</label>
                                <input type="number" class="form-control" id="discountValue" name="discount_value" required 
                                       min="0.01" step="0.01" placeholder="50">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="minFare" class="form-label">Minimum Fare (₹)</label>
                                <input type="number" class="form-control" id="minFare" name="min_fare" 
                                       min="0" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="expiryDate" class="form-label">Expiry Date</label>
                                <input type="date" class="form-control" id="expiryDate" name="expiry_date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="rideType" class="form-label">Ride Type Restriction</label>
                                <select class="form-select" id="rideType" name="ride_type">
                                    <option value="">All Ride Types</option>
                                    <option value="hatchback">Hatchback</option>
                                    <option value="sedan">Sedan</option>
                                    <option value="suv">SUV</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="rideCategory" class="form-label">Ride Category Restriction</label>
                                <select class="form-select" id="rideCategory" name="ride_category">
                                    <option value="">All Categories</option>
                                    <option value="regular">Regular</option>
                                    <option value="airport">Airport</option>
                                    <option value="rental">Rental</option>
                                    <option value="outstation">Outstation</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="isActive" name="active" checked>
                        <label class="form-check-label" for="isActive">
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Promo Code</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Promo Code Modal -->
<div class="modal fade" id="editPromoModal" tabindex="-1" aria-labelledby="editPromoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPromoModalLabel">Edit Promo Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editPromoForm">
                <input type="hidden" id="editPromoId" name="promo_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPromoCode" class="form-label">Promo Code</label>
                                <input type="text" class="form-control" id="editPromoCode" name="code" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editMaxUses" class="form-label">Max Uses *</label>
                                <input type="number" class="form-control" id="editMaxUses" name="max_uses" required min="1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDiscountType" class="form-label">Discount Type *</label>
                                <select class="form-select" id="editDiscountType" name="discount_type" required>
                                    <option value="flat">Flat Amount (₹)</option>
                                    <option value="percent">Percentage (%)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDiscountValue" class="form-label">Discount Value *</label>
                                <input type="number" class="form-control" id="editDiscountValue" name="discount_value" required min="0.01" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editMinFare" class="form-label">Minimum Fare (₹)</label>
                                <input type="number" class="form-control" id="editMinFare" name="min_fare" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editExpiryDate" class="form-label">Expiry Date</label>
                                <input type="date" class="form-control" id="editExpiryDate" name="expiry_date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editRideType" class="form-label">Ride Type Restriction</label>
                                <select class="form-select" id="editRideType" name="ride_type">
                                    <option value="">All Ride Types</option>
                                    <option value="hatchback">Hatchback</option>
                                    <option value="sedan">Sedan</option>
                                    <option value="suv">SUV</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editRideCategory" class="form-label">Ride Category Restriction</label>
                                <select class="form-select" id="editRideCategory" name="ride_category">
                                    <option value="">All Categories</option>
                                    <option value="regular">Regular</option>
                                    <option value="airport">Airport</option>
                                    <option value="rental">Rental</option>
                                    <option value="outstation">Outstation</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="editIsActive" name="active">
                        <label class="form-check-label" for="editIsActive">
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Promo Code</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadPromoCodes();
    
    // Auto-uppercase promo code input
    document.getElementById('promoCode').addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });
    
    // Create promo code form submission
    document.getElementById('createPromoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createPromoCode();
    });
    
    // Edit promo code form submission
    document.getElementById('editPromoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updatePromoCode();
    });
});

function loadPromoCodes() {
    fetch('/admin/api/promo-codes')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderPromoCodesTable(data.data);
            } else {
                console.error('Error loading promo codes:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading promo codes:', error);
        });
}

function renderPromoCodesTable(promoCodes) {
    const tableBody = document.querySelector('#promoCodesTable tbody');
    tableBody.innerHTML = '';
    
    promoCodes.forEach(promo => {
        const row = document.createElement('tr');
        
        // Format discount display
        const discountDisplay = promo.discount_type === 'flat' ? 
            `₹${promo.discount_value}` : 
            `${promo.discount_value}%`;
        
        // Format expiry date
        const expiryDisplay = promo.expiry_date ? 
            new Date(promo.expiry_date).toLocaleDateString() : 
            'Never';
        
        // Format restrictions
        const restrictions = [];
        if (promo.ride_type) restrictions.push(`Type: ${promo.ride_type}`);
        if (promo.ride_category) restrictions.push(`Category: ${promo.ride_category}`);
        const restrictionsDisplay = restrictions.length > 0 ? restrictions.join(', ') : 'None';
        
        // Usage progress bar
        const usagePercentage = promo.usage_percentage || 0;
        const usageBar = `
            <div class="progress" style="height: 20px;">
                <div class="progress-bar" role="progressbar" style="width: ${usagePercentage}%;" 
                     aria-valuenow="${usagePercentage}" aria-valuemin="0" aria-valuemax="100">
                    ${promo.current_uses}/${promo.max_uses}
                </div>
            </div>
        `;
        
        row.innerHTML = `
            <td><strong>${promo.code}</strong></td>
            <td>${discountDisplay}</td>
            <td>₹${promo.min_fare}</td>
            <td>${usageBar}</td>
            <td>${expiryDisplay}</td>
            <td><small>${restrictionsDisplay}</small></td>
            <td>
                <span class="badge ${promo.active ? 'bg-success' : 'bg-secondary'}">
                    ${promo.active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editPromoCode(${promo.id})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deletePromoCode(${promo.id}, '${promo.code}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

function createPromoCode() {
    const formData = new FormData(document.getElementById('createPromoForm'));
    const data = Object.fromEntries(formData.entries());
    
    // Convert checkbox to boolean
    data.active = document.getElementById('isActive').checked;
    
    fetch('/admin/api/promo_codes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Promo code created successfully!');
            document.getElementById('createPromoForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('createPromoModal')).hide();
            loadPromoCodes();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error creating promo code:', error);
        alert('Error creating promo code');
    });
}

function editPromoCode(promoId) {
    fetch(`/admin/api/promo_codes`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const promo = data.data.find(p => p.id === promoId);
                if (promo) {
                    // Fill edit form
                    document.getElementById('editPromoId').value = promo.id;
                    document.getElementById('editPromoCode').value = promo.code;
                    document.getElementById('editMaxUses').value = promo.max_uses;
                    document.getElementById('editDiscountType').value = promo.discount_type;
                    document.getElementById('editDiscountValue').value = promo.discount_value;
                    document.getElementById('editMinFare').value = promo.min_fare;
                    document.getElementById('editExpiryDate').value = promo.expiry_date || '';
                    document.getElementById('editRideType').value = promo.ride_type || '';
                    document.getElementById('editRideCategory').value = promo.ride_category || '';
                    document.getElementById('editIsActive').checked = promo.active;
                    
                    // Show modal
                    new bootstrap.Modal(document.getElementById('editPromoModal')).show();
                }
            }
        })
        .catch(error => {
            console.error('Error loading promo code:', error);
        });
}

function updatePromoCode() {
    const formData = new FormData(document.getElementById('editPromoForm'));
    const data = Object.fromEntries(formData.entries());
    const promoId = data.promo_id;
    
    // Convert checkbox to boolean
    data.active = document.getElementById('editIsActive').checked;
    delete data.promo_id;
    
    fetch(`/admin/api/promo_codes/${promoId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Promo code updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('editPromoModal')).hide();
            loadPromoCodes();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error updating promo code:', error);
        alert('Error updating promo code');
    });
}

function deletePromoCode(promoId, promoCode) {
    if (confirm(`Are you sure you want to delete promo code "${promoCode}"?`)) {
        fetch(`/admin/api/promo_codes/${promoId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Promo code deleted successfully!');
                loadPromoCodes();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting promo code:', error);
            alert('Error deleting promo code');
        });
    }
}
</script>
{% endblock %}