{% extends "admin/base.html" %}

{% block title %}Live Map - TaxiBook Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Live Driver Map</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleFilters()">
                <i class="bi bi-funnel"></i> Filters
            </button>
            <button type="button" class="btn btn-sm btn-outline-info" onclick="toggleDriverList()">
                <i class="bi bi-list"></i> Driver List
            </button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-success" id="autoRefreshBtn" onclick="toggleAutoRefresh()">
                <i class="bi bi-arrow-clockwise"></i> Auto Refresh: ON
            </button>
            <button type="button" class="btn btn-sm btn-primary" onclick="refreshDrivers()">
                <i class="bi bi-arrow-clockwise"></i> Refresh Now
            </button>
        </div>
    </div>
</div>

<!-- Filters Panel -->
<div class="card mb-3" id="filters-panel" style="display: none;">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter" onchange="applyFilters()">
                    <option value="">All Status</option>
                    <option value="online">Online</option>
                    <option value="busy">Busy</option>
                    <option value="offline">Offline</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="companyFilter" class="form-label">Company</label>
                <select class="form-select" id="companyFilter" onchange="applyFilters()">
                    <option value="">All Companies</option>
                    <option value="A1 Taxi">A1 Taxi</option>
                    <option value="Blue Cab">Blue Cab</option>
                    <option value="Green Ride">Green Ride</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="zoneFilter" class="form-label">Zone</label>
                <select class="form-select" id="zoneFilter" onchange="applyFilters()">
                    <option value="">All Zones</option>
                    <!-- Zones will be populated dynamically -->
                </select>
            </div>
            <div class="col-md-3">
                <label for="vehicleFilter" class="form-label">Vehicle Type</label>
                <select class="form-select" id="vehicleFilter" onchange="applyFilters()">
                    <option value="">All Types</option>
                    <option value="hatchback">Hatchback</option>
                    <option value="sedan">Sedan</option>
                    <option value="suv">SUV</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Map Container -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-body p-0">
                <div id="map" style="height: 600px; width: 100%;"></div>
            </div>
        </div>
    </div>
    
    <!-- Driver List Panel -->
    <div class="col-md-3" id="driver-list-panel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-people"></i> Active Drivers
                    <span class="badge bg-primary ms-2" id="driver-count">0</span>
                </h5>
            </div>
            <div class="card-body p-0" style="max-height: 550px; overflow-y: auto;">
                <div id="driver-list-container">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Driver Details Modal -->
<div class="modal fade" id="driverDetailsModal" tabindex="-1" aria-labelledby="driverDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="driverDetailsModalLabel">Driver Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="driver-details-content">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let map;
let markers = [];
let driversData = [];
let filteredDrivers = [];
let autoRefreshInterval;
let isAutoRefresh = true;

// Company colors for markers
const companyColors = {
    'A1 Taxi': '#dc3545',      // Red
    'Blue Cab': '#007bff',     // Blue
    'Green Ride': '#28a745',   // Green
    'default': '#6c757d'       // Gray
};

function initMap() {
    // Initialize map centered on Hosur
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: { lat: 12.7400, lng: 77.8253 }, // Hosur coordinates
        mapTypeId: 'roadmap',
        styles: [
            {
                featureType: 'poi',
                elementType: 'labels',
                stylers: [{ visibility: 'off' }]
            }
        ]
    });
    
    // Start auto refresh
    startAutoRefresh();
    
    // Initial load
    refreshDrivers();
    
    // Load zones for filter
    loadZones();
}

function refreshDrivers() {
    fetch('/admin/api/live_driver_locations')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                driversData = data.data.drivers;
                applyFilters();
            } else {
                showError('Failed to load driver locations');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Network error occurred');
        });
}

function displayDriversOnMap(drivers) {
    // Clear existing markers
    markers.forEach(marker => marker.setMap(null));
    markers = [];
    
    // Add new markers
    drivers.forEach(driver => {
        if (driver.current_lat && driver.current_lng) {
            const marker = createDriverMarker(driver);
            markers.push(marker);
        }
    });
    
    // Update driver list
    displayDriverList(drivers);
    
    // Update count
    document.getElementById('driver-count').textContent = drivers.length;
}

function createDriverMarker(driver) {
    const position = { lat: driver.current_lat, lng: driver.current_lng };
    
    // Determine marker color based on company
    const companyName = driver.company_name || 'default';
    const color = companyColors[companyName] || companyColors['default'];
    
    // Create marker with custom icon
    const marker = new google.maps.Marker({
        position: position,
        map: map,
        title: `${driver.name} (${driver.phone})`,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: color,
            fillOpacity: driver.out_of_zone ? 0.4 : 0.8,
            strokeColor: '#ffffff',
            strokeWeight: 2
        },
        animation: google.maps.Animation.DROP
    });
    
    // Create info window
    const infoWindow = new google.maps.InfoWindow({
        content: createInfoWindowContent(driver)
    });
    
    // Add click listener
    marker.addListener('click', () => {
        // Close all other info windows
        markers.forEach(m => {
            if (m.infoWindow) {
                m.infoWindow.close();
            }
        });
        
        infoWindow.open(map, marker);
    });
    
    // Store info window reference
    marker.infoWindow = infoWindow;
    
    return marker;
}

function createInfoWindowContent(driver) {
    const statusBadge = getStatusBadge(driver.is_online, driver.out_of_zone);
    const typeBadge = getTypeBadge(driver.car_type);
    
    return `
        <div class="info-window">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0">${driver.name}</h6>
                ${statusBadge}
            </div>
            <p class="mb-1">
                <i class="bi bi-telephone"></i> ${driver.phone}<br>
                <i class="bi bi-car-front"></i> ${driver.car_number || 'N/A'} ${typeBadge}<br>
                <i class="bi bi-building"></i> ${driver.company_name || 'N/A'}<br>
                <i class="bi bi-geo-alt"></i> ${driver.zone || 'No zone'}
            </p>
            <button class="btn btn-sm btn-primary" onclick="showDriverDetails(${driver.id})">
                <i class="bi bi-eye"></i> View Details
            </button>
        </div>
    `;
}

function displayDriverList(drivers) {
    const container = document.getElementById('driver-list-container');
    
    if (drivers.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3">
                <i class="bi bi-person-x text-muted"></i>
                <p class="text-muted small mt-2">No drivers found</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    drivers.forEach(driver => {
        const statusBadge = getStatusBadge(driver.is_online, driver.out_of_zone);
        const typeBadge = getTypeBadge(driver.car_type);
        const companyColor = companyColors[driver.company_name] || companyColors['default'];
        
        html += `
            <div class="driver-item p-2 border-bottom" onclick="focusOnDriver(${driver.id})">
                <div class="d-flex align-items-center">
                    <div class="driver-marker-preview" style="background-color: ${companyColor}; opacity: ${driver.out_of_zone ? 0.4 : 0.8}"></div>
                    <div class="ms-2 flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-0 small">${driver.name}</h6>
                            ${statusBadge}
                        </div>
                        <p class="mb-0 small text-muted">
                            ${driver.phone}<br>
                            ${driver.car_number || 'N/A'} ${typeBadge}
                        </p>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function focusOnDriver(driverId) {
    const driver = driversData.find(d => d.id === driverId);
    if (driver && driver.current_lat && driver.current_lng) {
        const position = { lat: driver.current_lat, lng: driver.current_lng };
        map.setCenter(position);
        map.setZoom(15);
        
        // Find and open the marker's info window
        const marker = markers.find(m => m.getTitle().includes(driver.name));
        if (marker && marker.infoWindow) {
            marker.infoWindow.open(map, marker);
        }
    }
}

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const companyFilter = document.getElementById('companyFilter').value;
    const zoneFilter = document.getElementById('zoneFilter').value;
    const vehicleFilter = document.getElementById('vehicleFilter').value;
    
    filteredDrivers = driversData.filter(driver => {
        // Status filter
        if (statusFilter) {
            if (statusFilter === 'online' && (!driver.is_online || driver.out_of_zone)) return false;
            if (statusFilter === 'busy' && (driver.is_online && !driver.out_of_zone && driver.current_ride)) return false;
            if (statusFilter === 'offline' && driver.is_online) return false;
        }
        
        // Company filter
        if (companyFilter && driver.company_name !== companyFilter) return false;
        
        // Zone filter
        if (zoneFilter && driver.zone !== zoneFilter) return false;
        
        // Vehicle filter
        if (vehicleFilter && driver.car_type !== vehicleFilter) return false;
        
        return true;
    });
    
    displayDriversOnMap(filteredDrivers);
}

function showDriverDetails(driverId) {
    const driver = driversData.find(d => d.id === driverId);
    if (!driver) {
        showError('Driver not found');
        return;
    }
    
    const statusBadge = getStatusBadge(driver.is_online, driver.out_of_zone);
    const typeBadge = getTypeBadge(driver.car_type);
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Driver Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Name:</strong></td><td>${driver.name}</td></tr>
                    <tr><td><strong>Phone:</strong></td><td>${driver.phone}</td></tr>
                    <tr><td><strong>Status:</strong></td><td>${statusBadge}</td></tr>
                    <tr><td><strong>Company:</strong></td><td>${driver.company_name || 'N/A'}</td></tr>
                    <tr><td><strong>Zone:</strong></td><td>${driver.zone || 'No zone'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Vehicle Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Type:</strong></td><td>${typeBadge}</td></tr>
                    <tr><td><strong>Number:</strong></td><td>${driver.car_number || 'N/A'}</td></tr>
                    <tr><td><strong>Make:</strong></td><td>${driver.car_make || 'N/A'}</td></tr>
                    <tr><td><strong>Model:</strong></td><td>${driver.car_model || 'N/A'}</td></tr>
                    <tr><td><strong>Year:</strong></td><td>${driver.car_year || 'N/A'}</td></tr>
                </table>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-12">
                <h6>Location Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Latitude:</strong></td><td>${driver.current_lat || 'N/A'}</td></tr>
                    <tr><td><strong>Longitude:</strong></td><td>${driver.current_lng || 'N/A'}</td></tr>
                    <tr><td><strong>Last Update:</strong></td><td>${driver.location_updated_at ? formatDateTime(driver.location_updated_at) : 'N/A'}</td></tr>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('driver-details-content').innerHTML = content;
    
    const modal = new bootstrap.Modal(document.getElementById('driverDetailsModal'));
    modal.show();
}

function toggleFilters() {
    const panel = document.getElementById('filters-panel');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
    } else {
        panel.style.display = 'none';
    }
}

function toggleDriverList() {
    const panel = document.getElementById('driver-list-panel');
    const mapCol = document.querySelector('.col-md-9');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        mapCol.className = 'col-md-9';
    } else {
        panel.style.display = 'none';
        mapCol.className = 'col-md-12';
    }
    
    // Trigger map resize
    google.maps.event.trigger(map, 'resize');
}

function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    
    if (isAutoRefresh) {
        clearInterval(autoRefreshInterval);
        isAutoRefresh = false;
        btn.innerHTML = '<i class="bi bi-pause"></i> Auto Refresh: OFF';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-warning');
    } else {
        startAutoRefresh();
        isAutoRefresh = true;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Auto Refresh: ON';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
    }
}

function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        refreshDrivers();
    }, 3000); // Refresh every 3 seconds
}

function loadZones() {
    fetch('/admin/api/zones')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const zoneSelect = document.getElementById('zoneFilter');
                data.data.zones.forEach(zone => {
                    const option = document.createElement('option');
                    option.value = zone.zone_name;
                    option.textContent = zone.zone_name;
                    zoneSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading zones:', error);
        });
}

function getStatusBadge(isOnline, outOfZone) {
    if (!isOnline) {
        return '<span class="badge bg-secondary">Offline</span>';
    } else if (outOfZone) {
        return '<span class="badge bg-warning">Out of Zone</span>';
    } else {
        return '<span class="badge bg-success">Online</span>';
    }
}

function getTypeBadge(type) {
    const badges = {
        'hatchback': '<span class="badge bg-light text-dark">Hatchback</span>',
        'sedan': '<span class="badge bg-primary">Sedan</span>',
        'suv': '<span class="badge bg-success">SUV</span>'
    };
    return badges[type] || '<span class="badge bg-secondary">Unknown</span>';
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString();
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const main = document.querySelector('main .pt-3');
    main.insertBefore(alert, main.firstChild);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map when page loads
    if (typeof google !== 'undefined' && google.maps) {
        initMap();
    } else {
        // Fallback if Google Maps is not available
        document.getElementById('map').innerHTML = `
            <div class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center">
                    <i class="bi bi-map display-1 text-muted"></i>
                    <p class="mt-3 text-muted">Google Maps not available</p>
                    <p class="text-muted">Please check your API key configuration</p>
                </div>
            </div>
        `;
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>

<!-- Load Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>

<style>
.driver-marker-preview {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #ffffff;
    flex-shrink: 0;
}

.driver-item {
    cursor: pointer;
    transition: background-color 0.2s;
}

.driver-item:hover {
    background-color: var(--bs-light);
}

.info-window {
    max-width: 250px;
}

.info-window h6 {
    color: #495057;
}

.info-window .badge {
    font-size: 0.7rem;
}

#map {
    border-radius: 8px;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
{% endblock %}