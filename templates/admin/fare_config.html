<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fare Configuration - TaxiBook Admin</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <strong>TaxiBook Admin</strong>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/dashboard">Dashboard</a>
                <a class="nav-link" href="/admin/rides">Rides</a>
                <a class="nav-link" href="/admin/drivers">Drivers</a>
                <a class="nav-link" href="/admin/customers">Customers</a>
                <a class="nav-link active" href="/admin/fare_config">Fare Config</a>
                <a class="nav-link" href="/admin/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Fare Configuration Management</h2>
                    <button class="btn btn-secondary" onclick="refreshFareData()">
                        Refresh Data
                    </button>
                </div>

                <!-- Alert container for notifications -->
                <div id="alertContainer"></div>

                <!-- Fare Configuration Cards -->
                <div class="row" id="fareConfigContainer">
                    <!-- Fare configuration cards will be loaded here -->
                </div>

                <!-- Global Surge Multiplier -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Global Surge Multiplier</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="globalSurgeMultiplier" class="form-label">
                                        Surge Multiplier (applies to all ride types)
                                    </label>
                                    <input type="number" class="form-control" id="globalSurgeMultiplier" 
                                           step="0.1" min="0.5" max="5.0" value="1.0">
                                    <div class="form-text">
                                        1.0 = Normal pricing, 1.5 = 50% surge, 2.0 = Double pricing
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button class="btn btn-warning" onclick="updateGlobalSurge()">
                                    Update Global Surge
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fare Configuration Modal -->
    <div class="modal fade" id="fareConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fareConfigModalTitle">Edit Fare Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="fareConfigForm">
                        <input type="hidden" id="modalRideType">
                        
                        <div class="mb-3">
                            <label for="modalBaseFare" class="form-label">Base Fare (₹)</label>
                            <input type="number" class="form-control" id="modalBaseFare" 
                                   step="0.01" min="0" required>
                            <div class="form-text">Fixed amount charged at booking</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalPerKmRate" class="form-label">Per Kilometer Rate (₹)</label>
                            <input type="number" class="form-control" id="modalPerKmRate" 
                                   step="0.01" min="0" required>
                            <div class="form-text">Rate charged per kilometer of distance</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveFareConfig()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let fareConfigs = null;
        
        // Load fare configurations on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFareConfigurations();
        });
        
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
        
        function loadFareConfigurations() {
            fetch('/admin/api/fare_config')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.data && data.data.fare_configs) {
                        fareConfigs = data.data.fare_configs;
                        renderFareConfigCards();
                        updateGlobalSurgeDisplay();
                    } else {
                        showAlert('Failed to load fare configurations: ' + (data.message || 'Invalid response structure'), 'danger');
                        fareConfigs = [];
                    }
                })
                .catch(error => {
                    showAlert('Error loading fare configurations: ' + error.message, 'danger');
                });
        }
        
        function renderFareConfigCards() {
            const container = document.getElementById('fareConfigContainer');
            container.innerHTML = '';
            
            // Check if fareConfigs is defined and is an array
            if (!fareConfigs || !Array.isArray(fareConfigs)) {
                showAlert('No fare configurations available', 'warning');
                return;
            }
            
            fareConfigs.forEach(config => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-3';
                card.innerHTML = `
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-capitalize">${config.ride_type}</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="editFareConfig('${config.ride_type}')">
                                Edit
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <strong>Base Fare:</strong> ₹${config.base_fare}
                            </div>
                            <div class="mb-2">
                                <strong>Per KM Rate:</strong> ₹${config.per_km_rate}
                            </div>
                            <div class="mb-2">
                                <strong>Current Surge:</strong> ${config.surge_multiplier}x
                            </div>
                            <hr>
                            <div class="text-muted small">
                                <strong>Example (10km):</strong><br>
                                ₹${config.base_fare} + (10 × ₹${config.per_km_rate}) × ${config.surge_multiplier} = 
                                <strong>₹${((config.base_fare + (10 * config.per_km_rate)) * config.surge_multiplier).toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function updateGlobalSurgeDisplay() {
            if (fareConfigs && Array.isArray(fareConfigs) && fareConfigs.length > 0) {
                document.getElementById('globalSurgeMultiplier').value = fareConfigs[0].surge_multiplier;
            }
        }
        
        function editFareConfig(rideType) {
            if (!fareConfigs || !Array.isArray(fareConfigs)) {
                showAlert('Fare configurations not loaded', 'warning');
                return;
            }
            
            const config = fareConfigs.find(c => c.ride_type === rideType);
            if (!config) {
                showAlert('Fare configuration not found for ' + rideType, 'warning');
                return;
            }
            
            document.getElementById('modalRideType').value = rideType;
            document.getElementById('modalBaseFare').value = config.base_fare;
            document.getElementById('modalPerKmRate').value = config.per_km_rate;
            document.getElementById('fareConfigModalTitle').textContent = `Edit ${rideType.charAt(0).toUpperCase() + rideType.slice(1)} Fare Configuration`;
            
            const modal = new bootstrap.Modal(document.getElementById('fareConfigModal'));
            modal.show();
        }
        
        function saveFareConfig() {
            const rideType = document.getElementById('modalRideType').value;
            const baseFare = parseFloat(document.getElementById('modalBaseFare').value);
            const perKmRate = parseFloat(document.getElementById('modalPerKmRate').value);
            
            if (!baseFare || !perKmRate || baseFare < 0 || perKmRate < 0) {
                showAlert('Please enter valid positive values for base fare and per km rate', 'warning');
                return;
            }
            
            const data = {
                ride_type: rideType,
                base_fare: baseFare,
                per_km_rate: perKmRate
            };
            
            fetch('/admin/api/fare_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert(`${rideType.charAt(0).toUpperCase() + rideType.slice(1)} fare configuration updated successfully`, 'success');
                    loadFareConfigurations();
                    bootstrap.Modal.getInstance(document.getElementById('fareConfigModal')).hide();
                } else {
                    showAlert('Failed to update fare configuration: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error updating fare configuration: ' + error.message, 'danger');
            });
        }
        
        function updateGlobalSurge() {
            const surgeMultiplier = parseFloat(document.getElementById('globalSurgeMultiplier').value);
            
            if (!surgeMultiplier || surgeMultiplier < 0.5 || surgeMultiplier > 5.0) {
                showAlert('Please enter a valid surge multiplier between 0.5 and 5.0', 'warning');
                return;
            }
            
            const data = {
                surge_multiplier: surgeMultiplier
            };
            
            fetch('/admin/api/fare_config/surge', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert(`Global surge multiplier updated to ${surgeMultiplier}x`, 'success');
                    loadFareConfigurations();
                } else {
                    showAlert('Failed to update surge multiplier: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showAlert('Error updating surge multiplier: ' + error.message, 'danger');
            });
        }
        
        function refreshFareData() {
            loadFareConfigurations();
            showAlert('Fare data refreshed', 'info');
        }
    </script>
</body>
</html>